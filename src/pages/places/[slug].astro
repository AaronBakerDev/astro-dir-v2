---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../../app_v2/src/lib/supabase';

console.log('üöÄ Page Processing Started');
const rawId = Astro.params.id ?? '';
const id = parseInt(rawId, 10);

if (isNaN(id)) {
  console.error('‚ùå Invalid ID:', { rawId });
  return new Response('Invalid ID', { status: 400 });
}

const { data: place, error } = await supabase
  .from('places')
  .select('*')
  .eq('id', id)
  .single();

console.log('üîç Query Details:', {
  rawId,
  id,
  matchFound: !!place,
  error: error || 'No error',
  query: `SELECT * FROM places WHERE id = ${id}`,
});

if (error?.message) {
  console.error('‚ùå Database Error:', error);
  return new Response(`Database error: ${error.message}`, { status: 500 });
}

if (!place) {
  console.error('‚ùå Place not found:', { id });
  return new Response('Place not found', { status: 404 });
}

console.log('‚úÖ Place found:', place);

const description = [
  place.title,
  place.category,
  place.rating && `Rated ${place.rating}/5`,
  place.address,
]
  .filter(Boolean)
  .join(' - ');
---

<Layout title={place.title} description={description}>
  <div class='max-w-3xl mx-auto'>
    <nav class='mb-6'>
      <a
        href='/directory'
        class='text-primary-600 hover:text-primary-700 flex items-center gap-1'>
        <span>‚Üê</span> Back to Directory
      </a>
    </nav>

    <article class='bg-white rounded-lg shadow-sm border border-gray-200 p-8'>
      <header class='mb-8'>
        <h1 class='text-3xl font-bold text-gray-900 mb-2'>{place.title}</h1>
        {
          place.category && (
            <p class='text-primary-600 font-medium'>{place.category}</p>
          )
        }
      </header>

      {
        place.rating && (
          <section class='mb-8 pb-8 border-b border-gray-100'>
            <h2 class='text-lg font-semibold mb-2'>Rating</h2>
            <div class='flex items-center'>
              <span class='text-yellow-400 text-2xl'>‚òÖ</span>
              <span class='ml-2 text-xl font-medium'>{place.rating}</span>
              {place.rating_count && (
                <span class='text-gray-500 ml-2'>
                  ({place.rating_count.toLocaleString()} reviews)
                </span>
              )}
            </div>
          </section>
        )
      }

      {
        place.address && (
          <section class='mb-8 pb-8 border-b border-gray-100'>
            <h2 class='text-lg font-semibold mb-2'>Location</h2>
            <p class='text-gray-600'>{place.address}</p>
            {place.latitude && place.longitude && (
              <a
                href={`https://www.google.com/maps/search/?api=1&query=${place.latitude},${place.longitude}`}
                target='_blank'
                rel='noopener noreferrer'
                class='inline-flex items-center text-primary-600 hover:text-primary-700 mt-3'>
                <span class='mr-1'>üó∫Ô∏è</span> View on Google Maps
              </a>
            )}
          </section>
        )
      }

      <div class='space-y-6'>
        {
          place.phone_number && (
            <section>
              <h2 class='text-lg font-semibold mb-2'>Contact</h2>
              <a
                href={`tel:${place.phone_number}`}
                class='text-primary-600 hover:text-primary-700 flex items-center gap-2'>
                <span />
                {place.phone_number}
              </a>
            </section>
          )
        }

        {
          place.website && (
            <section>
              <h2 class='text-lg font-semibold mb-2'>Website</h2>
              <a
                href={place.website}
                target='_blank'
                rel='noopener noreferrer'
                class='text-primary-600 hover:text-primary-700 flex items-center gap-2'>
                <span>üåê</span>
                Visit Website
              </a>
            </section>
          )
        }
      </div>

      <footer class='mt-8 pt-6 border-t border-gray-200 text-sm text-gray-500'>
        <p>Listed since {new Date(place.created_at).toLocaleDateString()}</p>
      </footer>
    </article>
  </div>
</Layout>
